<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administração</title>
  <link rel="stylesheet" href="admin.css">
<link rel="icon" type="image/png" href="logo.png" />
</head>
<body>
<header class="topo">
  <h1>Painel de Administração</h1>
  <nav class="menu-admin">
    <button class="btn-nav" data-target="instrutores">Instrutores</button>
    <button class="btn-nav" data-target="avaliacoes">Avaliações</button>
  </nav>
</header>

  <main>
  <!-- Tela de Instrutores -->
  <section id="tela-instrutores" class="tela ativa">
    <!-- Lista de instrutores pendentes -->
    <section class="lista-instrutores">
      <h2>Solicitações Pendentes</h2>
      <table>
        <thead>
          <tr>
            <th>Nome Completo</th>
            <th>Email</th>
            <th>CPF</th>
            <th>Cidade</th>
            <th>Estado</th>
            <th>Telefone</th>
            <th>Selfie</th>
            <th>Comprovante</th>
            <th>CNH</th>
            <th>Certificado</th>
            <th>Categoria</th>
            <th>Status</th>
            <th>Mensalidade</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaPendentes"></tbody>
      </table>
    </section>

    <!-- Lista de instrutores aceitos -->
    <section class="lista-instrutores">
      <h2>Instrutores Aceitos</h2>
      <table>
        <thead>
          <tr>
            <th>Nome Completo</th>
            <th>Email</th>
            <th>CPF</th>
            <th>Cidade</th>
            <th>Estado</th>
            <th>Telefone</th>
            <th>Selfie</th>
            <th>Comprovante</th>
            <th>CNH</th>
            <th>Certificado</th>
            <th>Categoria</th>
            <th>Status</th>
            <th>Mensalidade</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaAceitos"></tbody>
      </table>
    </section>
  </section>

  <!-- Tela de Avaliações -->
  <section id="tela-avaliacoes" class="tela">
    <section class="lista-avaliacoes">
      <h2>Avaliações Pendentes</h2>
      <table>
        <thead>
          <tr>
            <th>Instrutor</th>
            <th>Nome</th>
            <th>Sobrenome</th>
            <th>IP</th>
            <th>Telefone</th>
            <th>Estrelas</th>
            <th>Comentário</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaAvaliacoesPendentes"></tbody>
      </table>
    </section>

    <section class="lista-avaliacoes">
      <h2>Avaliações Aceitas</h2>
      <table>
        <thead>
          <tr>
            <th>Instrutor</th>
            <th>Nome</th>
            <th>Sobrenome</th>
            <th>IP</th>
            <th>Telefone</th>
            <th>Estrelas</th>
            <th>Comentário</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tabelaAvaliacoesAceitas"></tbody>
      </table>
    </section>
  </section>
</main>

<script>
async function carregarInstrutores() {
  try {
    const resposta = await fetch("https://meuinstrutor.onrender.com/instrutores/todos");
    if (!resposta.ok) throw new Error("Erro ao carregar instrutores");

    const instrutores = await resposta.json();
    const tabelaPendentes = document.getElementById("tabelaPendentes");
    const tabelaAceitos = document.getElementById("tabelaAceitos");
    tabelaPendentes.innerHTML = "";
    tabelaAceitos.innerHTML = "";

    instrutores.forEach(instrutor => {
      let cronometroHtml = "";
      if (instrutor.status === "aceito") {
        if (instrutor.data_pagamento) {
          const ultimaData = new Date(instrutor.data_pagamento);
          const hoje = new Date();
          const vencimento = new Date(ultimaData);
          vencimento.setMonth(vencimento.getMonth() + 1);

          const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));

          if (diasRestantes > 0) {
            cronometroHtml = `<span style="color:green; font-weight:bold;">${diasRestantes} dias restantes</span>`;
          } else {
            const primeiroNome = instrutor.nome.split(" ")[0];
            const mensagem = `Olá ${primeiroNome}, sua mensalidade de R$19,90 venceu. Para continuar na plataforma, realize o pagamento.`;
            const linkWhatsapp = `https://wa.me/${instrutor.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(mensagem)}`;
            cronometroHtml = `<span style="color:red; font-weight:bold;">Vencido</span><br>
                              <a href="${linkWhatsapp}" target="_blank" class="btn-whatsapp">Cobrar no WhatsApp</a>`;
          }
        } else {
          cronometroHtml = `<span style="color:gray;">Sem pagamento registrado</span>`;
        }
      } else {
        cronometroHtml = `<span style="color:gray;">--</span>`;
      }

      const linha = `
        <tr>
          <td>${instrutor.nome}</td>
          <td>${instrutor.email}</td>
          <td>${instrutor.cpf}</td>
          <td>${instrutor.cidade}</td>
          <td>${instrutor.estado}</td>
          <td>
  ${instrutor.telefone 
    ? `<a href="https://wa.me/55${instrutor.telefone.replace(/\D/g,'')}" 
         target="_blank" 
         class="btn-whatsapp">WhatsApp</a>` 
    : "-"}
</td>
          <td>${instrutor.selfie ? `<img src="${instrutor.selfie}" width="80"><br>` : ""}</td>
          <td>${instrutor.comprovante_residencia ? `<img src="${instrutor.comprovante_residencia}" width="80"><br>` : ""}</td>
          <td>${instrutor.cnh ? `<img src="${instrutor.cnh}" width="80"><br>` : ""}</td>
          <td>${instrutor.certificado ? `<img src="${instrutor.certificado}" width="80"><br>` : ""}</td>
          <td>${instrutor.categorias}</td>
          <td style="color:${instrutor.status === "aceito" ? "green" : "black"}; font-weight:bold;">
            ${instrutor.status === "aceito" ? "✔ Aceito" : "Pendente"}
          </td>
          <td>${cronometroHtml}</td>
          <td>
            ${instrutor.status === "aceito"
              ? `<button class="excluir" data-id="${instrutor.id}">Excluir</button>`
              : `<button class="admitir" data-id="${instrutor.id}">Aceitar</button>
                 <button class="excluir" data-id="${instrutor.id}">Recusar</button>`}
          </td>
        </tr>
      `;

      if (instrutor.status === "aceito") {
        tabelaAceitos.innerHTML += linha;
      } else {
        tabelaPendentes.innerHTML += linha;
      }
    });
  } catch (err) {
    console.error("❌ Erro ao carregar instrutores:", err);
    alert("Erro ao carregar instrutores");
  }
}

async function carregarAvaliacoes() {
  try {
    const resposta = await fetch("https://meuinstrutor.onrender.com/avaliacoes/todas");
    if (!resposta.ok) throw new Error("Erro ao carregar avaliações");

    const avaliacoes = await resposta.json();
    const tabelaPendentes = document.getElementById("tabelaAvaliacoesPendentes");
    const tabelaAceitas = document.getElementById("tabelaAvaliacoesAceitas");
    tabelaPendentes.innerHTML = "";
    tabelaAceitas.innerHTML = "";

    avaliacoes.forEach(av => {
      const linha = `
        <tr>
          <td>${av.instrutor_id}</td>
          <td>${av.primeiro_nome}</td>
          <td>${av.sobrenome}</td>
          <td>${av.ip || "-"}</td>
          <td>
  ${av.telefone 
    ? `<a href="https://wa.me/55${av.telefone.replace(/\D/g,'')}" 
         target="_blank" 
         class="btn-whatsapp">WhatsApp</a>` 
    : "-"}
</td>
          <td>${"★".repeat(av.estrelas)}${"☆".repeat(5-av.estrelas)}</td>
          <td>${av.comentario}</td>
          <td>${av.status}</td>
          <td>
            ${av.status === "pendente"
              ? `<button class="aceitar-av" data-id="${av.id}">Aceitar</button>
                 <button class="recusar-av" data-id="${av.id}">Recusar</button>`
              : `<button class="apagar-av" data-id="${av.id}">Apagar</button>`}
          </td>
        </tr>
      `;
      if (av.status === "pendente") {
        tabelaPendentes.innerHTML += linha;
      } else {
        tabelaAceitas.innerHTML += linha;
      }
    });
  } catch (err) {
    console.error("❌ Erro ao carregar avaliações:", err);
    alert("Erro ao carregar avaliações");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const tabela = document.querySelector("main");

  // Alternar telas ao clicar nos botões do menu
  const navButtons = document.querySelectorAll(".btn-nav");
  const telas = document.querySelectorAll(".tela");

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      const targetId = target === "instrutores" ? "tela-instrutores" : "tela-avaliacoes";

      telas.forEach(sec => sec.classList.remove("ativa"));
      document.getElementById(targetId).classList.add("ativa");

      navButtons.forEach(b => b.classList.remove("ativo"));
      btn.classList.add("ativo");

      if (target === "instrutores") {
        carregarInstrutores();
      } else {
        carregarAvaliacoes();
      }
    });
  });

  tabela.addEventListener("click", async (e) => {
    const id = e.target.dataset.id;
    if (!id) return;

    try {
      if (e.target.classList.contains("admitir")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/aceitar/${id}`, { method: "PUT" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      if (e.target.classList.contains("excluir")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}`, { method: "DELETE" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      if (e.target.classList.contains("aceitar-av")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/avaliacoes/aceitar/${id}`, { method: "PATCH" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarAvaliacoes();
      }

      if (e.target.classList.contains("recusar-av")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/avaliacoes/${id}`, { method: "DELETE" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarAvaliacoes();
      }

      if (e.target.classList.contains("apagar-av")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/avaliacoes/apagar/${id}`, { method: "DELETE" });
        const resultado = await resposta.json();
        alert(resultado.mensagem);
        carregarAvaliacoes();
      }
    } catch (err) {
      console.error("❌ Erro na ação:", err);
      alert("Erro ao executar ação");
    }
  });

  // Inicializa com instrutores
  carregarInstrutores();
});
</script>
</body>
</html>