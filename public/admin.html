<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administra√ß√£o</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <header class="topo">
    <h1>Painel de Administra√ß√£o</h1>
  </header>

  <main>
    <!-- Lista de instrutores pendentes -->
    <section class="lista-instrutores">
      <h2>Solicita√ß√µes Pendentes</h2>
      <table>
        <thead>
          <tr>
            <th>Nome Completo</th>
            <th>Email</th>
            <th>CPF</th>
            <th>Cidade</th>
            <th>Estado</th>
            <th>Telefone</th>
            <th>Selfie</th>
            <th>Comprovante</th>
            <th>CNH</th>
            <th>Certificado</th>
            <th>Categoria</th>
            <th>Status</th>
            <th>Mensalidade</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaPendentes"></tbody>
      </table>
    </section>

    <!-- Lista de instrutores aceitos -->
    <section class="lista-instrutores">
      <h2>Instrutores Aceitos</h2>
      <table>
        <thead>
          <tr>
            <th>Nome Completo</th>
            <th>Email</th>
            <th>CPF</th>
            <th>Cidade</th>
            <th>Estado</th>
            <th>Telefone</th>
            <th>Selfie</th>
            <th>Comprovante</th>
            <th>CNH</th>
            <th>Certificado</th>
            <th>Categoria</th>
            <th>Status</th>
            <th>Mensalidade</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaAceitos"></tbody>
      </table>
    </section>
  </main>

  <script>
async function carregarInstrutores() {
  const resposta = await fetch("https://meuinstrutor.onrender.com/instrutores/todos");
  if (!resposta.ok) {
    alert("Erro ao carregar instrutores");
    return;
  }
  const instrutores = await resposta.json();

  const tabelaPendentes = document.getElementById("tabelaPendentes");
  const tabelaAceitos = document.getElementById("tabelaAceitos");
  tabelaPendentes.innerHTML = "";
  tabelaAceitos.innerHTML = "";

  instrutores.forEach(instrutor => {
  // üîë Fallback para imagens nulas
  const selfieUrl = instrutor.selfie || "https://res.cloudinary.com/dzwkr47ib/image/upload/v1234567890/placeholder.jpg";
  const comprovanteUrl = instrutor.comprovante_residencia || "https://res.cloudinary.com/dzwkr47ib/image/upload/v1234567890/placeholder.jpg";
  const cnhUrl = instrutor.cnh || "https://res.cloudinary.com/dzwkr47ib/image/upload/v1234567890/placeholder.jpg";
  const certificadoUrl = instrutor.certificado || "https://res.cloudinary.com/dzwkr47ib/image/upload/v1234567890/placeholder.jpg";

  // üîé Cron√¥metro de mensalidade
  let cronometroHtml = "";
  if (instrutor.status === "aceito") {
    if (instrutor.data_pagamento) {
      const ultimaData = new Date(instrutor.data_pagamento);
      const hoje = new Date();
      const vencimento = new Date(ultimaData);
      vencimento.setMonth(vencimento.getMonth() + 1);

      const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));

      if (diasRestantes > 0) {
        cronometroHtml = `<span style="color:green; font-weight:bold;">${diasRestantes} dias restantes</span>`;
      } else {
        const primeiroNome = instrutor.nome.split(" ")[0];
        const mensagem = `Ol√° ${primeiroNome}, sua mensalidade de R$19,90 venceu. Para continuar na plataforma, realize o pagamento.`;
        const linkWhatsapp = `https://wa.me/${instrutor.telefone.replace(/\D/g,'')}?text=${encodeURIComponent(mensagem)}`;
        cronometroHtml = `<span style="color:red; font-weight:bold;">Vencido</span><br>
                          <a href="${linkWhatsapp}" target="_blank" class="btn-whatsapp">Cobrar no WhatsApp</a>`;
      }
    } else {
      cronometroHtml = `<span style="color:gray;">Sem pagamento registrado</span>`;
    }
  } else {
    cronometroHtml = `<span style="color:gray;">--</span>`;
  }

  const linha = `
    <tr>
      <td>${instrutor.nome}</td>
      <td>${instrutor.email}</td>
      <td>${instrutor.cpf}</td>
      <td>${instrutor.cidade}</td>
      <td>${instrutor.estado}</td>
      <td>${instrutor.telefone}</td>
      <td>
        <img src="${selfieUrl}" width="80"><br>
        <input type="file" id="selfie-${instrutor.id}" class="input-file upload-selfie" data-id="${instrutor.id}">
        <label for="selfie-${instrutor.id}" class="btn-minimal">Escolher</label>
        <button class="btn-minimal btn-secondary atualizar-selfie" data-id="${instrutor.id}">Mudar</button>
      </td>
      <td>
        <img src="${comprovanteUrl}" width="80"><br>
        <input type="file" id="comprovante-${instrutor.id}" class="input-file upload-comprovante" data-id="${instrutor.id}">
        <label for="comprovante-${instrutor.id}" class="btn-minimal">Escolher</label>
        <button class="btn-minimal btn-secondary atualizar-comprovante" data-id="${instrutor.id}">Mudar</button>
      </td>
      <td>
        <img src="${cnhUrl}" width="80"><br>
        <input type="file" id="cnh-${instrutor.id}" class="input-file upload-cnh" data-id="${instrutor.id}">
        <label for="cnh-${instrutor.id}" class="btn-minimal">Escolher</label>
        <button class="btn-minimal btn-secondary atualizar-cnh" data-id="${instrutor.id}">Mudar</button>
      </td>
      <td>
        <img src="${certificadoUrl}" width="80"><br>
        <input type="file" id="certificado-${instrutor.id}" class="input-file upload-certificado" data-id="${instrutor.id}">
        <label for="certificado-${instrutor.id}" class="btn-minimal">Escolher</label>
        <button class="btn-minimal btn-secondary atualizar-certificado" data-id="${instrutor.id}">Mudar</button>
      </td>
      <td>${instrutor.categorias}</td>
      <td style="color:${instrutor.status === "aceito" ? "green" : "black"}; font-weight:bold;">
        ${instrutor.status === "aceito" ? "‚úî Aceito" : "Pendente"}
      </td>
      <td>${cronometroHtml}</td>
      <td>
        ${instrutor.status === "aceito"
          ? `<button class="excluir" data-id="${instrutor.id}">Excluir</button>`
          : `<button class="admitir" data-id="${instrutor.id}">Aceitar</button>
             <button class="excluir" data-id="${instrutor.id}">Recusar</button>`}
      </td>
    </tr>
  `;

  if (instrutor.status === "aceito") {
    tabelaAceitos.innerHTML += linha;
  } else {
    tabelaPendentes.innerHTML += linha;
  }
});
}
  document.addEventListener("DOMContentLoaded", () => {
    const tabela = document.querySelector("main");

    tabela.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;

      // Aceitar
      if (e.target.classList.contains("admitir")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/aceitar/${id}`, { method: "PUT" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      // Excluir
      if (e.target.classList.contains("excluir")) {
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}`, { method: "DELETE" });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      // Atualizar Selfie
      if (e.target.classList.contains("atualizar-selfie")) {
        const input = document.querySelector(`.upload-selfie[data-id="${id}"]`);
        const file = input.files[0];
        if (!file) { alert("Selecione uma selfie primeiro!"); return; }
        const formData = new FormData();
        formData.append("selfie", file);
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}/selfie`, { method: "PUT", body: formData });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      // Atualizar Comprovante
      if (e.target.classList.contains("atualizar-comprovante")) {
        const input = document.querySelector(`.upload-comprovante[data-id="${id}"]`);
        const file = input.files[0];
        if (!file) { alert("Selecione um comprovante primeiro!"); return; }
        const formData = new FormData();
        formData.append("comprovante", file);
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}/comprovante`, { method: "PUT", body: formData });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      // Atualizar CNH
      if (e.target.classList.contains("atualizar-cnh")) {
        const input = document.querySelector(`.upload-cnh[data-id="${id}"]`);
        const file = input.files[0];
        if (!file) { alert("Selecione uma CNH primeiro!"); return; }
        const formData = new FormData();
        formData.append("cnh", file);
        const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}/cnh`, { method: "PUT", body: formData });
        const resultado = await resposta.json();
        alert(resultado.message);
        carregarInstrutores();
      }

      // Atualizar Certificado
if (e.target.classList.contains("atualizar-certificado")) {
  const input = document.querySelector(`.upload-certificado[data-id="${id}"]`);
  const file = input.files[0];
  if (!file) { alert("Selecione um certificado primeiro!"); return; }
  const formData = new FormData();
  formData.append("certificado", file);
  const resposta = await fetch(`https://meuinstrutor.onrender.com/instrutores/${id}/certificado`, { 
    method: "PUT", 
    body: formData 
  });
  const resultado = await resposta.json();
  alert(resultado.message);
  carregarInstrutores();
}
    });

    carregarInstrutores();
  });
  </script>
</body>
</html>